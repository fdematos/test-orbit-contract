<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>

  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://pixijs.download/v4.5.5/pixi.min.js"></script>
<body>
  <script type="text/javascript">

  function degrees_to_radians(degrees)
  {
    var pi = Math.PI;
    return degrees * (pi/180);
  }

  function refreshPosition() {
    web3.eth.getBlockNumber().then(function(block){
    blockText.text = "Block: "+block

      comethGameContract.methods.shipsInGame().call().then(function(result){
          result.forEach(element => {

            var blockDiff = block - element.position.lastUpdateBlock
            var currentAngle = degrees_to_radians((element.position.angle + (blockDiff * 20) ) % 360)

            var x = element.position.distance * 4 * Math.cos(currentAngle) + 400
            var y= element.position.distance * 3 * Math.sin(currentAngle) + 300

            console.log(x+" "+y)

            let text = new PIXI.Text(element.modelId ,{fontFamily : 'Arial', fontSize: 21, fill : 0xff1010, align : 'center'});
            text.x = x
            text.y = y

            app.stage.addChild(text);

          });
      });


      comethGameContract.methods.cometsInGame().call().then(function(result){
          result.forEach(element => {

            var blockDiff = block - element.position.lastUpdateBlock
            var currentAngle = degrees_to_radians((element.position.angle + (blockDiff * 30) ) % 360)

            var x = element.position.distance * 4 * Math.cos(currentAngle) + 400 + element.rotationCenterX * 4
            var y= element.position.distance * 3 * Math.sin(currentAngle) + 300 + element.rotationCenterY * 3

            console.log(element)
            console.log(x+" "+y)

            let text = new PIXI.Text("CO" ,{fontFamily : 'Arial', fontSize: 21, fill : 0x0000FF, align : 'center'});
            text.x = x
            text.y = y

            app.stage.addChild(text);

          });
      });



    });
  }

  var comethGameAbi = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"_modelId","type":"string"},{"indexed":false,"internalType":"uint256","name":"_block","type":"uint256"},{"indexed":false,"internalType":"uint32","name":"_distance","type":"uint32"},{"indexed":false,"internalType":"uint16","name":"_angle","type":"uint16"}],"name":"ShipMove","type":"event"},{"inputs":[{"internalType":"address","name":"cometAddr","type":"address"}],"name":"addComet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"modelId","type":"string"}],"name":"addShip","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"cometRotationSpeed","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"comethPosition","outputs":[{"internalType":"uint32","name":"distance","type":"uint32"},{"internalType":"uint16","name":"angle","type":"uint16"},{"internalType":"uint256","name":"lastUpdateBlock","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cometsInGame","outputs":[{"components":[{"internalType":"address","name":"cometAddr","type":"address"},{"internalType":"uint32","name":"rotationCenterX","type":"uint32"},{"internalType":"uint32","name":"rotationCenterY","type":"uint32"},{"components":[{"internalType":"uint32","name":"distance","type":"uint32"},{"internalType":"uint16","name":"angle","type":"uint16"},{"internalType":"uint256","name":"lastUpdateBlock","type":"uint256"}],"internalType":"struct Position","name":"position","type":"tuple"}],"internalType":"struct Comet[]","name":"comets","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rotationSpeed","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"shipPositions","outputs":[{"internalType":"uint32","name":"distance","type":"uint32"},{"internalType":"uint16","name":"angle","type":"uint16"},{"internalType":"uint256","name":"lastUpdateBlock","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"shipsInGame","outputs":[{"components":[{"internalType":"string","name":"modelId","type":"string"},{"components":[{"internalType":"uint32","name":"distance","type":"uint32"},{"internalType":"uint16","name":"angle","type":"uint16"},{"internalType":"uint256","name":"lastUpdateBlock","type":"uint256"}],"internalType":"struct Position","name":"position","type":"tuple"}],"internalType":"struct Ship[]","name":"ships","type":"tuple[]"}],"stateMutability":"view","type":"function"}]
  var web3 = new Web3(new Web3.providers.HttpProvider('https://rinkeby.infura.io/v3/5a1d2983f4e54626b951daa708fdbf0c'));

  var comethGameContract =  new web3.eth.Contract(comethGameAbi, "0x77211Fb1000C07b32Db5C41e5960Bdcd2b338F52")

  //Create a Pixi Application
  let app = new PIXI.Application({
    width: 1600, height: 1200,
    antialias: true,
    transparent: false,
    resolution: 1
  }
  );

  let blockText = new PIXI.Text("",{fontFamily : 'Arial', fontSize: 21, fill : 0xff1010, align : 'center'});
  app.stage.addChild(blockText);

  window.addEventListener('load', () => {

    document.body.appendChild(app.view);


    refreshPosition()
    setInterval(refreshPosition, 15000);



});


  </script>
</body>
</html>
